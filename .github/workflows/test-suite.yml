name: Comprehensive Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '18'
  RUST_VERSION: '1.70'

jobs:
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run frontend linting
      working-directory: ./frontend
      run: npm run lint
    
    - name: Run frontend type checking
      working-directory: ./frontend
      run: npm run type-check
    
    - name: Run frontend unit tests
      working-directory: ./frontend
      run: npm run test:run
    
    - name: Run frontend tests with coverage
      working-directory: ./frontend
      run: npm run test:coverage
    
    - name: Upload frontend coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bitcoin_custody_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
        components: rustfmt, clippy
    
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          backend/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}
    
    - name: Run backend linting
      working-directory: ./backend
      run: cargo fmt -- --check
    
    - name: Run backend clippy
      working-directory: ./backend
      run: cargo clippy -- -D warnings
    
    - name: Run backend unit tests
      working-directory: ./backend
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/bitcoin_custody_test
      run: cargo test --lib
    
    - name: Run backend integration tests
      working-directory: ./backend
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/bitcoin_custody_test
      run: cargo test --test '*'
    
    - name: Generate backend coverage
      working-directory: ./backend
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/bitcoin_custody_test
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out xml --output-dir coverage
    
    - name: Upload backend coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/coverage/cobertura.xml
        flags: backend
        name: backend-coverage

  soroban-tests:
    name: Soroban Contract Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        target: wasm32-unknown-unknown
        override: true
    
    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli --features opt
    
    - name: Cache Soroban dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          soroban/target/
        key: ${{ runner.os }}-soroban-${{ hashFiles('soroban/Cargo.lock') }}
    
    - name: Build Soroban contracts
      working-directory: ./soroban
      run: cargo build --target wasm32-unknown-unknown --release
    
    - name: Run Soroban contract tests
      working-directory: ./soroban
      run: cargo test
    
    - name: Run Soroban integration tests
      working-directory: ./soroban
      run: cargo test --test '*'

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bitcoin_custody_e2e
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
    
    - name: Install dependencies
      run: |
        cd frontend && npm ci
        cd ../backend && cargo build --release
    
    - name: Install Playwright
      working-directory: ./frontend
      run: npx playwright install --with-deps
    
    - name: Start backend server
      working-directory: ./backend
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/bitcoin_custody_e2e
      run: |
        cargo run --release &
        echo $! > backend.pid
        sleep 10
    
    - name: Start frontend server
      working-directory: ./frontend
      run: |
        npm run build
        npm run preview &
        echo $! > frontend.pid
        sleep 5
    
    - name: Run E2E tests
      working-directory: ./frontend
      run: npx playwright test src/test/e2e/
    
    - name: Upload E2E test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: e2e-test-results
        path: frontend/test-results/
    
    - name: Cleanup
      if: always()
      run: |
        if [ -f backend/backend.pid ]; then kill $(cat backend/backend.pid) || true; fi
        if [ -f frontend/frontend.pid ]; then kill $(cat frontend/frontend.pid) || true; fi

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
    
    - name: Install dependencies
      run: |
        cd frontend && npm ci
        cd ../backend && cargo build --release
    
    - name: Install Playwright
      working-directory: ./frontend
      run: npx playwright install --with-deps
    
    - name: Start services
      run: |
        cd backend && cargo run --release &
        echo $! > backend.pid
        sleep 10
        cd ../frontend && npm run preview &
        echo $! > frontend.pid
        sleep 5
    
    - name: Run performance tests
      working-directory: ./frontend
      run: npx playwright test src/test/performance/
    
    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-test-results
        path: frontend/test-results/
    
    - name: Cleanup
      if: always()
      run: |
        if [ -f backend.pid ]; then kill $(cat backend.pid) || true; fi
        if [ -f frontend/frontend.pid ]; then kill $(cat frontend/frontend.pid) || true; fi

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
    
    - name: Install dependencies
      run: |
        cd frontend && npm ci
        cd ../backend && cargo build --release
    
    - name: Install Playwright
      working-directory: ./frontend
      run: npx playwright install --with-deps
    
    - name: Run security audit (Node.js)
      working-directory: ./frontend
      run: npm audit --audit-level=high
    
    - name: Run security audit (Rust)
      working-directory: ./backend
      run: |
        cargo install cargo-audit
        cargo audit
    
    - name: Start services for security tests
      run: |
        cd backend && cargo run --release &
        echo $! > backend.pid
        sleep 10
        cd ../frontend && npm run preview &
        echo $! > frontend.pid
        sleep 5
    
    - name: Run security tests
      working-directory: ./frontend
      run: npx playwright test src/test/security/
    
    - name: Upload security test results
      uses: actions/upload-artifact@v3
      with:
        name: security-test-results
        path: frontend/test-results/
    
    - name: Cleanup
      if: always()
      run: |
        if [ -f backend.pid ]; then kill $(cat backend.pid) || true; fi
        if [ -f frontend/frontend.pid ]; then kill $(cat frontend/frontend.pid) || true; fi

  integration-validation:
    name: Full Stack Integration Validation
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, soroban-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bitcoin_custody_integration
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        target: wasm32-unknown-unknown
        override: true
    
    - name: Install Soroban CLI
      run: cargo install --locked soroban-cli --features opt
    
    - name: Build all components
      run: |
        cd frontend && npm ci && npm run build
        cd ../backend && cargo build --release
        cd ../soroban && cargo build --target wasm32-unknown-unknown --release
    
    - name: Run full stack integration tests
      working-directory: ./backend
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/bitcoin_custody_integration
      run: cargo test --test full_stack_test
    
    - name: Validate component compatibility
      run: |
        echo "Validating frontend-backend API compatibility..."
        # This would run API contract tests
        
        echo "Validating backend-soroban integration..."
        # This would test Soroban client integration
        
        echo "All integration validations passed!"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, soroban-tests, e2e-tests, performance-tests, security-tests, integration-validation]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Soroban Tests | ${{ needs.soroban-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Tests | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-validation.result }} |" >> $GITHUB_STEP_SUMMARY